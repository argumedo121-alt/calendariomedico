<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Pro + IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* Grid del Calendario */
        .calendar-wrapper { background-color: #cbd5e1; border-radius: 12px; padding: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        
        .calendar-day { 
            background-color: white; 
            min-height: 160px;
            border-radius: 8px; 
            padding: 8px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            position: relative;
            border: 1px solid transparent; /* Para evitar saltos al añadir borde en hover */
        }
        .weekend { background-color: #f1f5f9; border: 2px solid #e2e8f0; }

        /* Píldoras de Turno */
        .shift-pill { 
            padding: 10px 4px; 
            border-radius: 8px; 
            text-align: center; 
            margin-top: auto; 
            border: 1px solid transparent; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            line-height: 1;
        }

        .shift-main-text { 
            font-size: 1.25rem; 
            font-weight: 900; 
            letter-spacing: -0.05em;
            margin-bottom: 2px;
        }

        .shift-sub-text { 
            font-size: 0.75rem; 
            font-weight: 700; 
            opacity: 0.85; 
        }
        
        /* Colores */
        .shift-day { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .shift-night { background: #e0e7ff; color: #3730a3; border-color: #c7d2fe; }
        .shift-mixed { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
        .shift-rest { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .shift-absent { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

        /* Widget IA */
        .chat-widget {
            position: fixed; bottom: 2rem; right: 2rem;
            width: 400px; height: 600px;
            transform: translateY(120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50; display: flex; flex-col;
        }
        .chat-widget.open { transform: translateY(0); }

        /* Botones IA Estilizados */
        .ai-btn-style {
            @apply w-full p-4 rounded-xl border shadow-sm transition-all duration-200 text-left flex items-start gap-4 mb-3 relative overflow-hidden hover:-translate-y-1 hover:shadow-md;
        }

        /* PDF Helper */
        .pdf-clone-container { position: absolute; top: -9999px; left: -9999px; width: 1600px; background: white; padding: 20px; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center z-30 no-print shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2.5 rounded-lg shadow-lg">
                <i class="fa-solid fa-user-nurse text-lg"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Gestor de Turnos <span class="text-indigo-600">AI</span></h1>
        </div>
        <div class="flex gap-3">
            <button onclick="openConfig()" class="bg-white border border-slate-300 text-slate-600 hover:border-indigo-500 hover:text-indigo-600 px-4 py-2 rounded-lg font-semibold transition text-sm">
                <i class="fa-solid fa-sliders mr-2"></i> Datos
            </button>
            <button onclick="downloadICS()" id="btnICS" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-lg disabled:opacity-50 transition text-sm" disabled>
                <i class="fa-solid fa-calendar-days mr-2"></i> G. Calendar
            </button>
            <button onclick="downloadPDF()" id="btnDownload" class="bg-slate-900 hover:bg-black text-white px-4 py-2 rounded-lg font-bold shadow-lg disabled:opacity-50 transition text-sm" disabled>
                <i class="fa-solid fa-download mr-2"></i> PDF
            </button>
        </div>
    </nav>

    <!-- Main Layout -->
    <main class="flex-1 overflow-auto p-4 md:p-8 bg-[#f8fafc]">
        
        <!-- Empty State -->
        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center">
            <div class="bg-white p-10 rounded-2xl shadow-xl border border-slate-100 max-w-lg">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                    <i class="fa-regular fa-calendar-plus text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">Comencemos</h2>
                <p class="text-slate-500 mb-8">Carga la secuencia de turnos para visualizar la malla.</p>
                <button onclick="openConfig()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1">
                    Configurar Malla
                </button>
            </div>
        </div>

        <!-- Schedule Container -->
        <div id="scheduleContainer" class="hidden max-w-[1400px] mx-auto pb-24">
            
            <!-- Header Info -->
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 px-1">
                <div>
                    <h2 class="text-4xl font-extrabold text-slate-900 tracking-tight uppercase" id="displayMonthYear">MES AÑO</h2>
                    <p class="text-slate-500 font-bold mt-1 text-xl flex items-center gap-2">
                        <i class="fa-solid fa-user-doctor text-indigo-500"></i> <span id="displayEmployee">Nombre</span>
                    </p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
                <!-- 1. Total Horas -->
                <div class="bg-slate-800 text-white p-3 rounded-xl shadow-md text-center transform hover:scale-105 transition-transform">
                    <div class="text-[10px] font-bold text-slate-300 uppercase tracking-wider">Total Horas</div>
                    <div class="text-3xl font-black" id="totalHours">0</div>
                </div>
                <!-- 2. H. Diurnas -->
                <div class="bg-white border border-blue-100 p-3 rounded-xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">Ord. Diurna</div>
                    <div class="text-2xl font-black text-slate-700" id="hoursDay">0</div>
                </div>
                <!-- 3. H. Nocturnas -->
                <div class="bg-white border border-indigo-100 p-3 rounded-xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-indigo-500 uppercase tracking-wider">Ord. Nocturna</div>
                    <div class="text-2xl font-black text-slate-700" id="hoursNight">0</div>
                </div>
                <!-- 4. Festivas Diurnas -->
                <div class="bg-white border border-orange-100 p-3 rounded-xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-orange-500 uppercase tracking-wider">Fest. Diurna</div>
                    <div class="text-2xl font-black text-slate-700" id="hoursHolDay">0</div>
                </div>
                <!-- 5. Festivas Nocturnas -->
                <div class="bg-white border border-purple-100 p-3 rounded-xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-purple-500 uppercase tracking-wider">Fest. Nocturna</div>
                    <div class="text-2xl font-black text-slate-700" id="hoursHolNight">0</div>
                </div>
                 <!-- 6. Total Turnos -->
                 <div class="bg-green-50 border border-green-200 p-3 rounded-xl shadow-sm text-center">
                    <div class="text-[10px] font-bold text-green-600 uppercase tracking-wider">Turnos</div>
                    <div class="text-3xl font-black text-green-700" id="totalShifts">0</div>
                </div>
            </div>

            <!-- Calendar Wrapper (Target for PDF) -->
            <div id="pdfTarget">
                <div class="calendar-wrapper">
                    <div class="grid grid-cols-7 gap-2 mb-2 px-2">
                        <div class="text-center font-bold text-slate-500 text-sm uppercase py-2">Lunes</div>
                        <div class="text-center font-bold text-slate-500 text-sm uppercase py-2">Martes</div>
                        <div class="text-center font-bold text-slate-500 text-sm uppercase py-2">Miércoles</div>
                        <div class="text-center font-bold text-slate-500 text-sm uppercase py-2">Jueves</div>
                        <div class="text-center font-bold text-slate-500 text-sm uppercase py-2">Viernes</div>
                        <div class="text-center font-bold text-orange-500 text-sm uppercase py-2">Sábado</div>
                        <div class="text-center font-bold text-red-500 text-sm uppercase py-2">Domingo</div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>
                
                <!-- Legend -->
                <div class="mt-4 flex flex-wrap gap-4 justify-center text-xs font-bold text-slate-500">
                    <div class="flex items-center"><span class="w-4 h-4 bg-blue-100 border border-blue-300 rounded mr-2"></span> Diurno</div>
                    <div class="flex items-center"><span class="w-4 h-4 bg-indigo-100 border border-indigo-300 rounded mr-2"></span> Noche/Mixto</div>
                    <div class="flex items-center"><span class="w-4 h-4 bg-green-100 border border-green-300 rounded mr-2"></span> Descanso</div>
                    <div class="flex items-center"><i class="fa-solid fa-flag text-red-500 text-base mr-2"></i> Festivo</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Config Panel -->
    <div id="configPanel" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col no-print">
        <div class="bg-white border-b border-slate-100 p-6 flex justify-between items-center">
            <h3 class="text-xl font-bold text-slate-800">Configuración</h3>
            <button onclick="closeConfig()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500 transition"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 flex-1 overflow-y-auto space-y-6">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Nombre Profesional</label>
                <input type="text" id="manualName" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Opcional">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Mes</label>
                    <select id="selectMonth" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11" selected>Diciembre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Año</label>
                    <input type="number" id="selectYear" value="2025" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Pegar Turnos (Excel/CSV)</label>
                <textarea id="inputData" class="w-full h-40 p-4 bg-slate-50 border border-slate-200 rounded-xl font-mono text-sm outline-none focus:ring-2 focus:ring-indigo-500 resize-none" placeholder="Ej: 7-19, 19-7, D, D..."></textarea>
                <button onclick="loadDemoData()" class="mt-2 text-xs text-indigo-600 font-bold hover:underline">Usar datos de prueba</button>
            </div>
            <button onclick="generateSchedule(); closeConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 transition mt-4">
                Generar Malla
            </button>
        </div>
    </div>

    <!-- AI Button -->
    <button onclick="toggleAI()" id="aiFab" class="fixed bottom-8 right-8 w-16 h-16 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-2xl shadow-indigo-400/50 flex items-center justify-center transition-transform hover:scale-105 z-40 hidden no-print border-4 border-white">
        <i class="fa-solid fa-wand-magic-sparkles text-2xl"></i>
    </button>

    <!-- AI Widget -->
    <div id="aiWidget" class="chat-widget bg-white rounded-t-3xl shadow-2xl flex flex-col border border-slate-200 no-print">
        <div class="bg-gradient-to-r from-indigo-600 to-violet-600 text-white p-5 rounded-t-3xl flex justify-between items-center shadow-md">
            <div>
                <h3 class="font-bold text-lg">Asistente Inteligente</h3>
                <p class="text-xs text-indigo-100 opacity-90">Análisis y optimización</p>
            </div>
            <button onclick="toggleAI()" class="opacity-80 hover:opacity-100 transition"><i class="fa-solid fa-chevron-down text-xl"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 bg-slate-50 custom-scrollbar" id="chatContent">
            <div id="aiActions" class="animate-fade-in space-y-3">
                <p class="text-xs text-slate-400 font-bold tracking-widest uppercase mb-4 ml-1">Selecciona una herramienta:</p>
                
                <!-- Botón 1: Riesgo -->
                <button onclick="askGemini('Analiza críticamente la malla buscando riesgos de fatiga laboral, turnos consecutivos excesivos o descansos insuficientes según normas de salud ocupacional.')" 
                        class="ai-btn-style bg-white border-rose-100 border-l-4 border-l-rose-500 hover:bg-rose-50">
                    <div class="bg-rose-100 text-rose-600 w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0">
                        <i class="fa-solid fa-heart-pulse"></i>
                    </div>
                    <div>
                        <div class="font-bold text-slate-800">Riesgo de Fatiga</div>
                        <div class="text-xs text-slate-500 mt-1">Detectar cansancio acumulado.</div>
                    </div>
                </button>

                <!-- Botón 2: Descansos -->
                <button onclick="askGemini('Analiza la calidad y frecuencia de los descansos. ¿Cuántos fines de semana completos tiene libres? ¿La distribución es equitativa?')" 
                        class="ai-btn-style bg-white border-sky-100 border-l-4 border-l-sky-500 hover:bg-sky-50">
                    <div class="bg-sky-100 text-sky-600 w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0">
                        <i class="fa-regular fa-calendar-check"></i>
                    </div>
                    <div>
                        <div class="font-bold text-slate-800">Calidad de Descansos</div>
                        <div class="text-xs text-slate-500 mt-1">Revisar fines de semana libres.</div>
                    </div>
                </button>

                <!-- Botón 3: Optimización -->
                <button onclick="askGemini('Analiza la malla buscando descansos aislados. Sugiere UNA estrategia de intercambio (swap) específica para juntar descansos, asegurando que el día de pago no supere las 12 horas. Sé concreto.')" 
                        class="ai-btn-style bg-white border-violet-100 border-l-4 border-l-violet-500 hover:bg-violet-50">
                    <div class="bg-violet-100 text-violet-600 w-10 h-10 rounded-full flex items-center justify-center text-lg flex-shrink-0">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <div>
                        <div class="font-bold text-slate-800">Optimizar Malla</div>
                        <div class="text-xs text-slate-500 mt-1">Sugerir cambios inteligentes.</div>
                    </div>
                </button>
            </div>
            <div id="chatHistory" class="mt-4 space-y-4"></div>
        </div>

        <div class="p-4 bg-white border-t border-slate-100">
            <div class="relative">
                <input type="text" id="customAiPrompt" placeholder="Pregunta personalizada..." class="w-full pl-4 pr-10 py-3 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition placeholder-slate-400">
                <button onclick="triggerCustomPrompt()" class="absolute right-2 top-2 p-1.5 text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
        
        <div id="aiLoader" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-20 hidden flex flex-col items-center justify-center rounded-t-3xl">
            <div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
            <span class="text-xs font-bold text-indigo-800 tracking-widest uppercase animate-pulse">Analizando...</span>
        </div>
    </div>

    <script>
        const openConfig = () => document.getElementById('configPanel').classList.remove('translate-x-full');
        const closeConfig = () => document.getElementById('configPanel').classList.add('translate-x-full');
        const toggleAI = () => document.getElementById('aiWidget').classList.toggle('open');
        
        const absenceCodes = {
            'ABAN': { desc: 'Abandono', class: 'shift-absent' }, 'AIS': { desc: 'Aislamiento', class: 'shift-absent' },
            'D': { desc: 'Descanso', class: 'shift-rest' }, 'I': { desc: 'Incapacidad', class: 'shift-absent' },
            'L': { desc: 'Libre', class: 'bg-white text-slate-400 border border-slate-200' },
            'V': { desc: 'Vacaciones', class: 'bg-yellow-100 text-yellow-800 border-yellow-300' },
            'LM': { desc: 'Lic. Maternidad', class: 'bg-pink-100 text-pink-800 border-pink-300' }
        };
        let currentShiftsForAI = [], currentStats = {}, currentEmployeeName = "", currentPeriod = "";
        let exportableEvents = [];

        function getColombianHolidays(year) {
            const generate = (y) => {
                const h = [`${y}-01-01`, `${y}-05-01`, `${y}-07-20`, `${y}-08-07`, `${y}-12-08`, `${y}-12-25`];
                const add = (d, n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
                const nextMon = (d) => { const w=d.getDay(); return w===1?d:add(d,(8-w)%7||1); };
                [`${y}-01-06`, `${y}-03-19`, `${y}-06-29`, `${y}-08-15`, `${y}-10-12`, `${y}-11-01`, `${y}-11-11`].forEach(s => h.push(nextMon(new Date(s+"T00:00:00")).toISOString().split('T')[0]));
                const a=y%19, b=Math.floor(y/100), c=y%100, d=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), H=(19*a+b-d-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-H-k)%7, m=Math.floor((a+11*H+22*l)/451), mo=Math.floor((H+l-7*m+114)/31), da=((H+l-7*m+114)%31)+1;
                const easter = new Date(y, mo-1, da);
                [-3, -2, 39, 60, 68].forEach(off => h.push((off>0?nextMon(add(easter, off)):add(easter, off)).toISOString().split('T')[0]));
                return h;
            }
            return new Set([...generate(year), ...generate(year+1)]);
        }

        function calculateHours(start, end, y, m, d, holidays) {
            let res = { total: 0, dayOrd: 0, nightOrd: 0, dayHol: 0, nightHol: 0 };
            let curr = new Date(y, m, d, start, 0);
            let fin = new Date(y, m, d, end, 0);
            if (end <= start) fin.setDate(fin.getDate() + 1);
            let safe = 0;
            while (curr < fin && safe++ < 48) {
                let h = curr.getHours();
                let isHol = holidays.has(curr.toISOString().split('T')[0]) || curr.getDay() === 0;
                let isNight = h >= 19 || h < 6;
                res.total++;
                if (isHol) isNight ? res.nightHol++ : res.dayHol++;
                else isNight ? res.nightOrd++ : res.dayOrd++;
                curr.setHours(curr.getHours() + 1);
            }
            return res;
        }

        function generateSchedule() {
            const input = document.getElementById('inputData').value;
            const year = parseInt(document.getElementById('selectYear').value);
            const month = parseInt(document.getElementById('selectMonth').value);
            const manualName = document.getElementById('manualName').value.trim();

            if (!input.trim()) { alert("Ingresa datos"); return; }

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('scheduleContainer').classList.remove('hidden');
            document.getElementById('aiFab').classList.remove('hidden');
            document.getElementById('btnDownload').disabled = false;
            document.getElementById('btnICS').disabled = false;
            document.getElementById('aiActions').classList.remove('hidden');
            document.getElementById('chatHistory').innerHTML = '';

            let parts = input.split(/[\t;,]/).map(p => p.trim()).filter(p => p !== "");
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let shiftData = parts;
            if (parts.length > daysInMonth) {
                let bestScore = -Infinity, bestIdx = 0;
                for (let i = 0; i <= parts.length - daysInMonth; i++) {
                    let score = 0;
                    parts.slice(i, i+daysInMonth).forEach(x => { if (x.match(/\d/)) score += 5; if (['D','N','L'].includes(x.toUpperCase())) score += 3; });
                    if (score > bestScore) { bestScore = score; bestIdx = i; }
                }
                shiftData = parts.slice(bestIdx, bestIdx + daysInMonth);
            }

            if (manualName) currentEmployeeName = manualName;
            else {
                const namePart = parts.find(p => p.length > 5 && isNaN(p) && !p.match(/\d-\d/));
                currentEmployeeName = namePart || "Profesional";
            }
            document.getElementById('displayEmployee').innerText = currentEmployeeName;
            
            const monthNames = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
            currentPeriod = `${monthNames[month]} ${year}`;
            document.getElementById('displayMonthYear').innerText = currentPeriod;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            let firstDay = new Date(year, month, 1).getDay();
            let startOff = firstDay === 0 ? 6 : firstDay - 1;
            for(let i=0; i<startOff; i++) grid.appendChild(Object.assign(document.createElement('div'), {className: "bg-slate-200 rounded-lg opacity-30"}));

            const holidays = getColombianHolidays(year);
            let st = { total: 0, dayOrd: 0, nightOrd: 0, dayHol: 0, nightHol: 0, shifts: 0 };
            let aiData = [];
            
            // RESET EXPORTABLE EVENTS
            exportableEvents = [];

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const isHol = holidays.has(date.toISOString().split('T')[0]);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                const cell = document.createElement('div');
                cell.className = `calendar-day ${isWeekend ? 'weekend' : ''} transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:z-10 hover:border-indigo-200 cursor-default`;
                
                const head = document.createElement('div');
                head.className = "flex justify-between items-start mb-1";
                head.innerHTML = `<span class="text-2xl font-black ${isHol||date.getDay()===0 ? 'text-red-500' : 'text-slate-700'}">${d}</span>`;
                if(isHol) head.innerHTML += '<i class="fa-solid fa-flag text-red-500 text-sm mt-2"></i>';
                cell.appendChild(head);

                const content = document.createElement('div');
                content.className = "flex flex-col gap-1 flex-1 justify-center";
                
                let raw = shiftData[d-1] || "";
                let code = raw.replace(/['"]+/g, '').trim().toUpperCase();
                let hrs = { total: 0, dayOrd: 0, nightOrd: 0, dayHol: 0, nightHol: 0 };

                // --- NUEVA LÓGICA DE PRIORI MEJORADA ---
                let prioriInfo = null;
                const prioriIndex = code.indexOf("PRIORI");
                if (prioriIndex !== -1) {
                    const prioriText = code.substring(prioriIndex).trim();
                    code = code.substring(0, prioriIndex).trim();
                    
                    let clean = prioriText.replace(/[()]/g, '').replace(/PRIORI[-\s]*T?/i, '').trim();
                    let parts = clean.match(/(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?\s*[-–]\s*(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?/i);
                    
                    if (parts) {
                        let h1 = parseInt(parts[1]);
                        let ampm1 = parts[3] ? parts[3].toUpperCase() : null;
                        let h2 = parseInt(parts[4]);
                        let ampm2 = parts[6] ? parts[6].toUpperCase() : null;
                        
                        if (!ampm1 && ampm2) {
                            let tempH2 = (ampm2 === 'PM' && h2 < 12) ? h2 + 12 : ((ampm2 === 'AM' && h2 === 12) ? 0 : h2);
                            if (tempH2 - h1 > 10) ampm1 = ampm2;
                        }
                        if (ampm1 === 'PM' && h1 < 12) h1 += 12;
                        if (ampm1 === 'AM' && h1 === 12) h1 = 0;
                        if (ampm2 === 'PM' && h2 < 12) h2 += 12;
                        if (ampm2 === 'AM' && h2 === 12) h2 = 0;
                        
                        prioriInfo = { s: h1, e: h2, text: `PRIORI ${h1.toString().padStart(2,'0')}:00 - ${h2.toString().padStart(2,'0')}:00` };
                    } else {
                         prioriInfo = { s: 0, e: 0, text: prioriText, unknown: true };
                    }
                }
                // -----------------------------------

                const ranges = [...code.matchAll(/(\d{1,2})(?:[:.]?(\d{2}))?\s*(?:-|A|TO)\s*(\d{1,2})/gi)];
                
                let mainShiftIntervals = [];

                if (ranges.length > 0) {
                    st.shifts++;
                    ranges.forEach(r => {
                        let s = parseInt(r[1]), e = parseInt(r[3]);
                        mainShiftIntervals.push({s, e});
                        let h = calculateHours(s, e, year, month, d, holidays);
                        st.total += h.total; 
                        st.dayOrd += h.dayOrd; st.nightOrd += h.nightOrd; 
                        st.dayHol += h.dayHol; st.nightHol += h.nightHol;
                        hrs.total += h.total;
                        let pillClass = (h.nightOrd + h.nightHol) > 0 ? ((h.dayOrd + h.dayHol) > 0 ? "shift-mixed" : "shift-night") : "shift-day";
                        content.innerHTML += `<div class="shift-pill ${pillClass} w-full"><span class="shift-main-text">${s} - ${e}</span><span class="shift-sub-text">${h.total}h</span></div>`;

                        // Add to export
                        let startDt = new Date(year, month, d, s, 0);
                        let endDt = new Date(year, month, d, e, 0);
                        if(e <= s) endDt.setDate(endDt.getDate() + 1);
                        exportableEvents.push({ start: startDt, end: endDt, title: `Turno ${s}-${e}` });
                    });
                } else if (code === "N") {
                    st.shifts++;
                    let s=19, e=7;
                    mainShiftIntervals.push({s, e});
                    let h = calculateHours(s, e, year, month, d, holidays);
                    st.total += h.total; st.dayOrd += h.dayOrd; st.nightOrd += h.nightOrd; st.dayHol += h.dayHol; st.nightHol += h.nightHol;
                    content.innerHTML += `<div class="shift-pill shift-night w-full"><span class="shift-main-text">19 - 07</span><span class="shift-sub-text">12h</span></div>`;
                    hrs.total = 12;

                    // Add to export
                    let startDt = new Date(year, month, d, 19, 0);
                    let endDt = new Date(year, month, d, 7, 0);
                    endDt.setDate(endDt.getDate() + 1);
                    exportableEvents.push({ start: startDt, end: endDt, title: `Turno 19-07` });

                } else if (absenceCodes[code]) {
                    content.innerHTML += `<div class="shift-pill ${absenceCodes[code].class} w-full"><span class="shift-main-text text-base">${code}</span><span class="text-[10px] uppercase font-bold mt-1">${absenceCodes[code].desc.split(' ')[0]}</span></div>`;
                    
                    // Add absence as full day event logic or specific hours? Let's assume all day for simplicity if no hours
                    // Standard calendar "All Day" starts at midnight
                    let startDt = new Date(year, month, d, 0, 0);
                    let endDt = new Date(year, month, d, 23, 59);
                    exportableEvents.push({ start: startDt, end: endDt, title: `${absenceCodes[code].desc} (${code})`, allDay: true });

                } else if (code && code !== "0") {
                    content.innerHTML += `<div class="shift-pill bg-slate-200 text-slate-600 w-full"><span class="font-bold text-base">${code}</span></div>`;
                }

                // --- EVALUAR PRIORI: DENTRO O FUERA? ---
                if (prioriInfo) {
                    let isInside = false;
                    if (!prioriInfo.unknown && mainShiftIntervals.length > 0) {
                        for (let main of mainShiftIntervals) {
                            let ms = main.s, me = main.e <= main.s ? main.e + 24 : main.e;
                            let ps = prioriInfo.s, pe = prioriInfo.e <= prioriInfo.s ? prioriInfo.e + 24 : prioriInfo.e;
                            if (ps >= ms && pe <= me) {
                                isInside = true;
                                break;
                            }
                        }
                    }

                    if (!isInside && !prioriInfo.unknown) {
                        let h = calculateHours(prioriInfo.s, prioriInfo.e, year, month, d, holidays);
                        st.total += h.total; 
                        st.dayOrd += h.dayOrd; st.nightOrd += h.nightOrd; 
                        st.dayHol += h.dayHol; st.nightHol += h.nightHol;
                         content.innerHTML += `<div class="mt-1 text-[9px] font-bold text-slate-600 leading-tight border-t border-slate-200 pt-1 break-words bg-yellow-50 rounded px-1 text-center border">${prioriInfo.text} (+${h.total}h)</div>`;
                        
                        // Add extra priori to export
                        let startDt = new Date(year, month, d, prioriInfo.s, 0);
                        let endDt = new Date(year, month, d, prioriInfo.e, 0);
                        if(prioriInfo.e <= prioriInfo.s) endDt.setDate(endDt.getDate() + 1);
                        exportableEvents.push({ start: startDt, end: endDt, title: `Extra: ${prioriInfo.text}` });

                    } else {
                        content.innerHTML += `<div class="mt-1 text-[9px] font-bold text-slate-500 leading-tight border-t border-slate-100 pt-1 break-words text-center">${prioriInfo.text}</div>`;
                        // Note: Internal Priori is just a note, usually not a separate calendar event, but could be added to description.
                    }
                }

                cell.appendChild(content);
                grid.appendChild(cell);
                aiData.push({ d, code, h: hrs.total });
            }

            const totalCells = startOff + daysInMonth;
            const rem = 7 - (totalCells % 7);
            if (rem < 7) for(let i=0; i<rem; i++) grid.appendChild(Object.assign(document.createElement('div'), {className: "bg-slate-200 rounded-lg opacity-30"}));

            document.getElementById('totalHours').innerText = st.total;
            document.getElementById('hoursDay').innerText = st.dayOrd;
            document.getElementById('hoursNight').innerText = st.nightOrd;
            document.getElementById('hoursHolDay').innerText = st.dayHol;
            document.getElementById('hoursHolNight').innerText = st.nightHol;
            document.getElementById('totalShifts').innerText = st.shifts;

            currentStats = st; currentShiftsForAI = aiData;
        }

        async function downloadPDF() {
            const btn = document.getElementById('btnDownload');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Generando...';
            btn.disabled = true;

            try {
                const original = document.getElementById('pdfTarget');
                const clone = original.cloneNode(true);
                const container = document.createElement('div');
                container.className = 'pdf-clone-container';
                container.appendChild(clone);
                document.body.appendChild(container);

                const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                document.body.removeChild(container);

                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
                const w = pdf.internal.pageSize.getWidth();
                const ratio = w / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 10, w, canvas.height * ratio);
                pdf.save(`Turnos_${currentEmployeeName.replace(/\s+/g,'_')}.pdf`);
            } catch (err) { alert("Error PDF"); } 
            finally { btn.innerHTML = originalHTML; btn.disabled = false; }
        }

        // --- NEW ICS LOGIC ---
        function formatICSDate(date, isAllDay = false) {
            const pad = n => n < 10 ? '0' + n : n;
            const y = date.getFullYear();
            const m = pad(date.getMonth() + 1);
            const d = pad(date.getDate());
            if (isAllDay) return `${y}${m}${d}`;
            const h = pad(date.getHours());
            const min = pad(date.getMinutes());
            const s = pad(date.getSeconds());
            return `${y}${m}${d}T${h}${min}${s}`;
        }

        function downloadICS() {
            if (exportableEvents.length === 0) { alert("No hay turnos para exportar."); return; }
            
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//GestorTurnosAI//NONSGML v1.0//ES\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n";
            
            const now = formatICSDate(new Date());

            exportableEvents.forEach((evt, index) => {
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `UID:turnos-${index}-${Date.now()}@gestorpro.ai\n`;
                icsContent += `DTSTAMP:${now}\n`;
                
                if (evt.allDay) {
                    icsContent += `DTSTART;VALUE=DATE:${formatICSDate(evt.start, true)}\n`;
                    // For all day events, end date is usually exclusive (+1 day), handled in generation or standard
                    icsContent += `DTEND;VALUE=DATE:${formatICSDate(evt.end, true)}\n`;
                } else {
                    icsContent += `DTSTART:${formatICSDate(evt.start)}\n`;
                    icsContent += `DTEND:${formatICSDate(evt.end)}\n`;
                }
                
                icsContent += `SUMMARY:${evt.title}\n`;
                icsContent += `DESCRIPTION:Generado por Gestor de Turnos AI\n`;
                icsContent += "END:VEVENT\n";
            });

            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', `Calendario_${currentEmployeeName.replace(/\s+/g,'_')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function askGemini(prompt) {
            const history = document.getElementById('chatHistory');
            const actions = document.getElementById('aiActions');
            const loader = document.getElementById('aiLoader');
            
            actions.classList.add('hidden');
            
            const userDiv = document.createElement('div');
            userDiv.className = "flex justify-end mb-4 animate-fade-in";
            userDiv.innerHTML = `<div class="bg-indigo-600 text-white px-4 py-2.5 rounded-2xl rounded-tr-sm text-sm shadow-md max-w-[85%]">${prompt}</div>`;
            history.appendChild(userDiv);
            
            loader.classList.remove('hidden');

            const sys = `Actúa como experto en planificación de turnos y salud en Colombia.
            Datos: ${currentEmployeeName}, ${currentPeriod}, ${currentStats.total}h totales.
            Turnos: ${JSON.stringify(currentShiftsForAI)}.
            INSTRUCCIONES:
            1. Sé EXTREMADAMENTE CONCISO (Max 60 palabras).
            2. Usa formato Markdown.
            3. Si sugieres cambios (swap), indica exactamente qué día mover a dónde.`;

            try {
                const response = await fetch("https://gemini-proxy.argumedo121.workers.dev/", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: sys + "\n\nUsuario: " + prompt })
                });
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta.";

                const aiDiv = document.createElement('div');
                aiDiv.className = "flex justify-start mb-6 animate-fade-in";
                aiDiv.innerHTML = `<div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-sm text-sm text-slate-700 shadow-sm prose prose-sm max-w-[95%]">${marked.parse(aiText)}</div>`;
                history.appendChild(aiDiv);
                
                const backBtn = document.createElement('button');
                backBtn.className = "text-xs text-indigo-500 hover:underline mx-auto block mb-4";
                backBtn.innerText = "← Volver al menú de opciones";
                backBtn.onclick = () => { actions.classList.remove('hidden'); history.innerHTML = ''; };
                history.appendChild(backBtn);

            } catch (e) {
                history.innerHTML += `<div class="text-center text-red-500 text-xs py-2">Error de conexión.</div>`;
            } finally { loader.classList.add('hidden'); }
        }

        function triggerCustomPrompt() { 
            const inp = document.getElementById('customAiPrompt'); 
            if(inp.value.trim()){ askGemini(inp.value); inp.value=''; }
        }

        function loadDemoData() {
            document.getElementById('inputData').value = "D, 7-19, 7-19, 19-7, 19-7, D, D, 7-19, 7-19, 19-7, D, D, 7-19, 13-19, V, V, V, V, V, 7-19, 7-19, D, 19-7, 19-7, D, D, 7-19, 7-19 PRIORI (7-9PM), D, D, 12-24";
            document.getElementById('manualName').value = "Dr. Alejandro Magno";
        }
    </script>
</body>
</html>
